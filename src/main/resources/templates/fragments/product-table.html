<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
    <div th:fragment="product-table" id="product-table-fragment">
        <!-- Search box -->
        <div style="margin-bottom: 1.5rem;">
            <input 
                type="text" 
                class="search-input" 
                placeholder="Search products by title..."
                name="query"
                th:value="${query}"
                hx-get="/products"
                hx-trigger="keyup changed delay:300ms"
                hx-target="#product-table-fragment"
                hx-swap="outerHTML"
                style="width: 100%; padding: 0.75rem 1rem; font-size: 1rem; border: 2px solid #ddd; border-radius: 8px;"
            >
        </div>
        
        <!-- Search results info -->
        <div th:if="${query != null and !query.isEmpty()}" style="margin-bottom: 1rem; color: #666;">
            <p th:text="'Found ' + ${products.size()} + ' results for: ' + ${query}"></p>
        </div>
        
        <table class="product-table" th:if="${products != null and !products.isEmpty()}">
            <thead>
                <tr>
                    <th>
                        <a href="#" 
                           th:attr="hx-get=@{/products(page=0,query=${query},sortBy='id',sortOrder=${sortBy == 'id' and sortOrder == 'asc' ? 'desc' : 'asc'})}"
                           hx-target="#product-table-fragment"
                           hx-swap="outerHTML"
                           style="color: #495057; text-decoration: none;">
                            ID
                            <span th:if="${sortBy == 'id' and sortOrder == 'asc'}">▲</span>
                            <span th:if="${sortBy == 'id' and sortOrder == 'desc'}">▼</span>
                        </a>
                    </th>
                    <th>
                        <a href="#" 
                           th:attr="hx-get=@{/products(page=0,query=${query},sortBy='title',sortOrder=${sortBy == 'title' and sortOrder == 'asc' ? 'desc' : 'asc'})}"
                           hx-target="#product-table-fragment"
                           hx-swap="outerHTML"
                           style="color: #495057; text-decoration: none;">
                            Title
                            <span th:if="${sortBy == 'title' and sortOrder == 'asc'}">▲</span>
                            <span th:if="${sortBy == 'title' and sortOrder == 'desc'}">▼</span>
                        </a>
                    </th>
                    <th>Product Type</th>
                    <th>Variants</th>
                    <th>Created At</th>
                    <th>Updated At</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="item : ${products}">
                    <td th:text="${item.product.id}"></td>
                    <td th:text="${item.product.title}"></td>
                    <td th:text="${item.product.productType ?: 'N/A'}"></td>
                    <td>
                        <div class="variant-list" th:if="${!item.variants.isEmpty()}">
                            <div th:each="variant : ${item.variants}">
                                <small>
                                    <span th:text="${variant.title}"></span>
                                    <span th:if="${variant.price}" th:text="' - ' + ${variant.price}"></span>
                                    <span th:if="${variant.available != null}">
                                        (<span th:text="${variant.available ? 'Available' : 'Not Available'}"></span>)
                                    </span>
                                </small>
                            </div>
                        </div>
                        <div th:if="${item.variants.isEmpty()}">
                            <small>No variants</small>
                        </div>
                    </td>
                    <td th:text="${#temporals.format(item.product.createdAt, 'yyyy-MM-dd HH:mm:ss')}"></td>
                    <td th:text="${#temporals.format(item.product.updatedAt, 'yyyy-MM-dd HH:mm:ss')}"></td>
                    <td>
                        <a th:href="@{/products/{id}/edit(id=${item.product.id})}" style="color: #007bff; text-decoration: none; margin-right: 1rem;">
                            Edit
                        </a>
                        <a href="#" 
                           th:attr="hx-delete=@{/products/{id}(id=${item.product.id})}"
                           hx-confirm="Are you sure you want to delete this product?"
                           hx-target="#product-table-fragment"
                           hx-swap="outerHTML"
                           style="color: #dc3545; text-decoration: none;">
                            Delete
                        </a>
                    </td>
                </tr>
            </tbody>
        </table>
        
        <!-- Pagination controls -->
        <div th:if="${totalPages > 1 and (query == null or query.isEmpty())}" style="margin-top: 1.5rem; text-align: center;">
            <div style="display: inline-flex; gap: 0.5rem; align-items: center;">
                <sl-button 
                    th:if="${currentPage > 0}"
                    variant="default" 
                    size="small"
                    th:attr="hx-get=@{/products(page=${currentPage - 1},sortBy=${sortBy},sortOrder=${sortOrder})}"
                    hx-target="#product-table-fragment"
                    hx-swap="outerHTML">
                    Previous
                </sl-button>
                
                <span th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}"
                      style="display: inline-block;">
                    <sl-button 
                        th:if="${pageNum == currentPage}"
                        variant="primary" 
                        size="small"
                        disabled>
                        <span th:text="${pageNum + 1}"></span>
                    </sl-button>
                    <sl-button 
                        th:if="${pageNum != currentPage}"
                        variant="default" 
                        size="small"
                        th:attr="hx-get=@{/products(page=${pageNum},sortBy=${sortBy},sortOrder=${sortOrder})}"
                        hx-target="#product-table-fragment"
                        hx-swap="outerHTML">
                        <span th:text="${pageNum + 1}"></span>
                    </sl-button>
                </span>
                
                <sl-button 
                    th:if="${currentPage < totalPages - 1}"
                    variant="default" 
                    size="small"
                    th:attr="hx-get=@{/products(page=${currentPage + 1},sortBy=${sortBy},sortOrder=${sortOrder})}"
                    hx-target="#product-table-fragment"
                    hx-swap="outerHTML">
                    Next
                </sl-button>
            </div>
        </div>
        
        <div th:if="${products == null or products.isEmpty()}" style="padding: 2rem; text-align: center; color: #666;">
            <p th:if="${query != null and !query.isEmpty()}">
                No products found for: <strong th:text="${query}"></strong>
            </p>
            <p th:if="${query == null or query.isEmpty()}">
                No products found. The scheduled job will sync products automatically.
            </p>
        </div>
        
        <!-- Add Product Form -->
        <div class="add-product-form">
            <h3>Add New Product</h3>
            <form id="add-product-form"
                  hx-post="/products" 
                  hx-target="#products-container" 
                  hx-swap="innerHTML">
                <div class="form-group">
                    <label for="title">Product Title *</label>
                    <input 
                        type="text"
                        id="title" 
                        name="title" 
                        class="form-control"
                        placeholder="Enter product title"
                        required>
                </div>
                
                <div class="form-group">
                    <label for="productType">Product Type</label>
                    <input 
                        type="text"
                        id="productType" 
                        name="productType" 
                        class="form-control"
                        placeholder="Enter product type (optional)">
                </div>
                
                <sl-button type="submit" variant="success">
                    Add Product
                </sl-button>
            </form>
        </div>
    </div>
</body>
</html>